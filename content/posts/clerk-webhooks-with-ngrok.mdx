---
title: Sử Dụng Clerk Webhooks với Ngrok
description: "Webhook là một cơ chế giúp website tự động thông báo và gửi dữ liệu thời gian thực đến các hệ thống khi có một sự kiện nào đó phát sinh trên website"
date: "2024-08-22T00:00:00Z"
image: https://res.cloudinary.com/daukjyo6s/image/upload/v1739932774/taitd.io.vn/2198f52b2bb1382d78469b0de94c962c25c0782d-4800x2520_1_k1lk5i.webp
---

## 1. Giới thiệu

Webhook là một cơ chế giúp website tự động thông báo và gửi dữ liệu **thời gian thực** đến các hệ thống khi có một sự kiện nào đó phát sinh trên website, ví dụ như thực hiện đăng ký, đăng nhập, add giỏ hàng, v.v.

**Clerk** là một nền tảng quản lý xác thực và người dùng, hỗ trợ webhook để gửi thông báo khi có thay đổi về người dùng, phiên đăng nhập, v.v.

**Ngrok** là công cụ tạo một đường hầm công khai (public tunnel) đến ứng dụng đang chạy trên local, giúp người khác mạng có thể truy cập được localhost của bạn thông qua custom domain của ngrok.
Ví dụ: `mydomain.ngrok.io` => `localhost:3000`

Trong bài viết này, chúng ta sẽ học cách:

- Cấu hình Clerk webhook với Next.js
- Chạy ngrok để nhận request từ Clerk.
- Kiểm tra và debug webhook.

## 2. Tạo project Next.js với Clerk

Trong bài viết này, mình sẽ sử dụng Next.js để đăng ký Webhook, tuy nhiên bạn có thể thực hiện tương tự với Express, Fastify hoặc các thư viện khác nhé.

### 2.1. Tạo project Next.js

Tạo project Next.js mới tích hợp sẵn Clerk.

```shell
git clone https://github.com/clerkinc/clerk-next-app.git
```

### 2.2. Tạo application trên Clerk Dashboard

- Đăng nhập vào **[Clerk Dashboard](https://dashboard.clerk.dev/)** và tạo một application mới

<Image
  src="https://res.cloudinary.com/daukjyo6s/image/upload/v1739945402/taitd.io.vn/socialscreenshots-2_19_2025_1_08_53_PM_am5oeg.png"
  width={1920}
  height={1024}
  alt="git"
/>

- Copy biến môi trường vào file `.env.local` tại thư mục gốc của project

<Image
  src="https://res.cloudinary.com/daukjyo6s/image/upload/v1739949709/taitd.io.vn/socialscreenshots-2_19_2025_2_20_56_PM_j48q3u.png"
  width={1920}
  height={1024}
  alt="git"
/>

```env
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=your_clerk_pub_key
CLERK_SECRET_KEY=your_clerk_secret_key
```

### 2.3. Run project

## 2. Tạo Webhook Trong Clerk

### Bước 1: Truy cập Trang Quản Lý Clerk

- Đăng nhập vào **[Clerk Dashboard](https://dashboard.clerk.dev/)**.
- Chọn **Webhooks** từ menu bên trái.
- Nhấn **Create Webhook**.

### Bước 2: Cấu hình Webhook

- **URL**: Ban đầu, có thể nhập tạm một URL placeholder, chúng ta sẽ cập nhật sau khi có đường dẫn từ ngrok.
- **Events**: Chọn các sự kiện mà bạn muốn webhook lắng nghe (ví dụ: `user.created`, `user.updated`).
- **Secret**: Lưu lại khóa bí mật để xác thực request webhook.

Nhấn **Create** để tạo webhook.

---

## 3. Chạy ứng dụng ở localhost

Chạy ứng dụng bằng lệnh

```shell
pnpm run dev
```

Màn hình chính của ứng dụng:

<Image
  src="https://res.cloudinary.com/daukjyo6s/image/upload/v1739954042/taitd.io.vn/socialscreenshots-2_19_2025_3_32_46_PM_wqw6gx.png"
  width={1920}
  height={1024}
  alt="git"
/>

Chúng ta sẽ tạo một ứng dụng đơn giản sử dụng **Node.js** với **Express.js** để nhận request webhook.

### Cài đặt Express

```sh
mkdir clerk-webhook && cd clerk-webhook
npm init -y
npm install express
```

### 3.1. Tạo Server Nhận Webhook

Tạo file `server.js` và thêm đoạn code sau:

```javascript
const express = require("express")
const app = express()
const PORT = 3000

app.use(express.json())

app.post("/webhook", (req, res) => {
  console.log("Received Clerk Webhook:", req.body)
  res.status(200).send("Webhook received")
})

app.listen(PORT, () => {
  console.log(`Server running on http://localhost:${PORT}`)
})
```

Chạy server:

```sh
node server.js
```

---

## 4. Chạy Ngrok

Ngrok giúp bạn tạo một URL công khai cho ứng dụng local:

### Cài đặt Ngrok

Nếu chưa có ngrok, cài đặt bằng lệnh:

```sh
npm install -g ngrok
```

### Chạy Ngrok

```sh
ngrok http 3000
```

Bạn sẽ nhận được một URL có dạng:

```
Forwarding https://random-subdomain.ngrok.io -> http://localhost:3000
```

Copy URL HTTPS để sử dụng trong bước tiếp theo.

---

## 5. Cập Nhật Webhook URL trong Clerk

Quay lại **Clerk Dashboard**, cập nhật URL webhook thành:

```
https://random-subdomain.ngrok.io/webhook
```

Nhấn **Save Changes**.

---

## 5. Kiểm Tra Webhook

Bạn có thể thử gửi một webhook test từ Clerk:

- Trong **Clerk Dashboard**, mở webhook vừa tạo.
- Nhấn **Send Test Event**.
- Kiểm tra terminal, bạn sẽ thấy dữ liệu webhook xuất hiện trong console của `server.js`.

Nếu webhook chạy thành công, bạn đã tích hợp Clerk Webhooks với ngrok thành công!

---

## 6. Xác Thực Webhook (Tùy Chọn)

Để đảm bảo webhook đến từ Clerk, bạn có thể xác thực bằng **Clerk Webhook Secret**.

Cài đặt thư viện crypto:

```sh
npm install crypto
```

Cập nhật `server.js` để xác thực webhook:

```javascript
const crypto = require("crypto")
const WEBHOOK_SECRET = "your-webhook-secret" // Lấy từ Clerk Dashboard

app.post("/webhook", (req, res) => {
  const signature = req.headers["clerk-signature"]
  const payload = JSON.stringify(req.body)
  const hash = crypto
    .createHmac("sha256", WEBHOOK_SECRET)
    .update(payload)
    .digest("hex")

  if (hash !== signature) {
    return res.status(401).send("Unauthorized")
  }

  console.log("Valid Webhook Received:", req.body)
  res.status(200).send("Webhook received")
})
```

---

## Kết Luận

Bạn vừa học cách thiết lập **Clerk Webhooks** trên local bằng **ngrok**. Đây là công cụ hữu ích khi thử nghiệm webhook mà không cần deploy lên server.

Tóm tắt các bước:

1. **Tạo webhook trong Clerk** và chọn sự kiện cần lắng nghe.
2. **Chạy ứng dụng Express** để nhận request webhook.
3. **Dùng ngrok** để tạo URL công khai.
4. **Cập nhật webhook URL** trong Clerk.
5. **Gửi test event** để kiểm tra webhook.
6. (Tùy chọn) **Xác thực webhook** bằng secret key.

Bạn có thể áp dụng cách này cho nhiều hệ thống webhook khác như Stripe, GitHub, v.v.
